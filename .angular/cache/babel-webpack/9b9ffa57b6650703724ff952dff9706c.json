{"ast":null,"code":"import _regeneratorRuntime from \"/Users/rohitgutal/angular-library-storybook/node_modules/@babel/runtime/regenerator\";\nimport \"core-js/modules/es.array.slice.js\";\nimport \"core-js/modules/es.object.freeze.js\";\n\nvar _templateObject, _templateObject2, _templateObject3, _templateObject4;\n\nimport \"regenerator-runtime/runtime.js\";\n\nfunction asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) {\n  try {\n    var info = gen[key](arg);\n    var value = info.value;\n  } catch (error) {\n    reject(error);\n    return;\n  }\n\n  if (info.done) {\n    resolve(value);\n  } else {\n    Promise.resolve(value).then(_next, _throw);\n  }\n}\n\nfunction _asyncToGenerator(fn) {\n  return function () {\n    var self = this,\n        args = arguments;\n    return new Promise(function (resolve, reject) {\n      var gen = fn.apply(self, args);\n\n      function _next(value) {\n        asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"next\", value);\n      }\n\n      function _throw(err) {\n        asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"throw\", err);\n      }\n\n      _next(undefined);\n    });\n  };\n}\n\nfunction _taggedTemplateLiteral(strings, raw) {\n  if (!raw) {\n    raw = strings.slice(0);\n  }\n\n  return Object.freeze(Object.defineProperties(strings, {\n    raw: {\n      value: Object.freeze(raw)\n    }\n  }));\n}\n\nfunction _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n}\n\nfunction _defineProperties(target, props) {\n  for (var i = 0; i < props.length; i++) {\n    var descriptor = props[i];\n    descriptor.enumerable = descriptor.enumerable || false;\n    descriptor.configurable = true;\n    if (\"value\" in descriptor) descriptor.writable = true;\n    Object.defineProperty(target, descriptor.key, descriptor);\n  }\n}\n\nfunction _createClass(Constructor, protoProps, staticProps) {\n  if (protoProps) _defineProperties(Constructor.prototype, protoProps);\n  if (staticProps) _defineProperties(Constructor, staticProps);\n  return Constructor;\n}\n\nimport \"core-js/modules/es.promise.js\";\nimport \"core-js/modules/es.object.to-string.js\";\nimport \"core-js/modules/es.object.keys.js\";\nimport \"core-js/modules/es.function.name.js\";\nimport \"core-js/modules/es.object.assign.js\";\nimport \"core-js/modules/es.array.includes.js\";\nimport \"core-js/modules/es.symbol.js\";\nimport \"core-js/modules/es.symbol.description.js\";\nimport \"core-js/modules/es.array.concat.js\";\nimport deprecate from 'util-deprecate';\nimport dedent from 'ts-dedent';\nimport global from 'global';\nimport { SynchronousPromise } from 'synchronous-promise';\nimport Events, { IGNORED_EXCEPTION } from '@storybook/core-events';\nimport { logger } from '@storybook/client-logger';\nimport { addons } from '@storybook/addons';\nimport { StoryStore } from '@storybook/store';\nimport { UrlStore } from './UrlStore';\nimport { WebView } from './WebView';\nvar globalWindow = global.window,\n    AbortController = global.AbortController,\n    fetch = global.fetch;\n\nfunction focusInInput(event) {\n  var target = event.target;\n  return /input|textarea/i.test(target.tagName) || target.getAttribute('contenteditable') !== null;\n}\n\nfunction createController() {\n  if (AbortController) return new AbortController(); // Polyfill for IE11\n\n  return {\n    signal: {\n      aborted: false\n    },\n    abort: function abort() {\n      this.signal.aborted = true;\n    }\n  };\n}\n\nvar STORY_INDEX_PATH = './stories.json';\nexport var PreviewWeb = /*#__PURE__*/function () {\n  function PreviewWeb() {\n    var _global$FEATURES,\n        _this = this;\n\n    _classCallCheck(this, PreviewWeb);\n\n    this.channel = void 0;\n    this.serverChannel = void 0;\n    this.urlStore = void 0;\n    this.storyStore = void 0;\n    this.view = void 0;\n    this.getStoryIndex = void 0;\n    this.importFn = void 0;\n    this.renderToDOM = void 0;\n    this.previousSelection = void 0;\n    this.previousStory = void 0;\n    this.previousCleanup = void 0;\n    this.abortController = void 0;\n    this.disableKeyListeners = void 0;\n    this.channel = addons.getChannel();\n\n    if ((_global$FEATURES = global.FEATURES) !== null && _global$FEATURES !== void 0 && _global$FEATURES.storyStoreV7 && addons.hasServerChannel()) {\n      this.serverChannel = addons.getServerChannel();\n    }\n\n    this.view = new WebView();\n    this.urlStore = new UrlStore();\n    this.storyStore = new StoryStore(); // Add deprecated APIs for back-compat\n    // @ts-ignore\n\n    this.storyStore.getSelection = deprecate(function () {\n      return _this.urlStore.selection;\n    }, dedent(_templateObject || (_templateObject = _taggedTemplateLiteral([\"\\n        `__STORYBOOK_STORY_STORE__.getSelection()` is deprecated and will be removed in 7.0.\\n  \\n        To get the current selection, use the `useStoryContext()` hook from `@storybook/addons`.\\n      \"], [\"\\n        \\\\`__STORYBOOK_STORY_STORE__.getSelection()\\\\` is deprecated and will be removed in 7.0.\\n  \\n        To get the current selection, use the \\\\`useStoryContext()\\\\` hook from \\\\`@storybook/addons\\\\`.\\n      \"]))));\n  } // INITIALIZATION\n  // NOTE: the reason that the preview and store's initialization code is written in a promise\n  // style and not `async-await`, and the use of `SynchronousPromise`s is in order to allow\n  // storyshots to immediately call `raw()` on the store without waiting for a later tick.\n  // (Even simple things like `Promise.resolve()` and `await` involve the callback happening\n  // in the next promise \"tick\").\n  // See the comment in `storyshots-core/src/api/index.ts` for more detail.\n\n\n  _createClass(PreviewWeb, [{\n    key: \"initialize\",\n    value: function initialize(_ref) {\n      var _this2 = this;\n\n      var getStoryIndex = _ref.getStoryIndex,\n          importFn = _ref.importFn,\n          getProjectAnnotations = _ref.getProjectAnnotations; // We save these two on initialization in case `getProjectAnnotations` errors,\n      // in which case we may need them later when we recover.\n\n      this.getStoryIndex = getStoryIndex;\n      this.importFn = importFn;\n      this.setupListeners();\n      return this.getProjectAnnotationsOrRenderError(getProjectAnnotations).then(function (projectAnnotations) {\n        return _this2.initializeWithProjectAnnotations(projectAnnotations);\n      });\n    }\n  }, {\n    key: \"setupListeners\",\n    value: function setupListeners() {\n      var _this$serverChannel;\n\n      globalWindow.onkeydown = this.onKeydown.bind(this);\n      (_this$serverChannel = this.serverChannel) === null || _this$serverChannel === void 0 ? void 0 : _this$serverChannel.on(Events.STORY_INDEX_INVALIDATED, this.onStoryIndexChanged.bind(this));\n      this.channel.on(Events.SET_CURRENT_STORY, this.onSetCurrentStory.bind(this));\n      this.channel.on(Events.UPDATE_QUERY_PARAMS, this.onUpdateQueryParams.bind(this));\n      this.channel.on(Events.UPDATE_GLOBALS, this.onUpdateGlobals.bind(this));\n      this.channel.on(Events.UPDATE_STORY_ARGS, this.onUpdateArgs.bind(this));\n      this.channel.on(Events.RESET_STORY_ARGS, this.onResetArgs.bind(this));\n    }\n  }, {\n    key: \"getProjectAnnotationsOrRenderError\",\n    value: function getProjectAnnotationsOrRenderError(getProjectAnnotations) {\n      var _this3 = this;\n\n      return SynchronousPromise.resolve().then(getProjectAnnotations).then(function (projectAnnotations) {\n        _this3.renderToDOM = projectAnnotations.renderToDOM;\n\n        if (!_this3.renderToDOM) {\n          throw new Error(dedent(_templateObject2 || (_templateObject2 = _taggedTemplateLiteral([\"\\n            Expected your framework's preset to export a `renderToDOM` field.\\n\\n            Perhaps it needs to be upgraded for Storybook 6.4?\\n\\n            More info: https://github.com/storybookjs/storybook/blob/next/MIGRATION.md#mainjs-framework-field          \\n          \"], [\"\\n            Expected your framework's preset to export a \\\\`renderToDOM\\\\` field.\\n\\n            Perhaps it needs to be upgraded for Storybook 6.4?\\n\\n            More info: https://github.com/storybookjs/storybook/blob/next/MIGRATION.md#mainjs-framework-field          \\n          \"]))));\n        }\n\n        return projectAnnotations;\n      }).catch(function (err) {\n        // This is an error extracting the projectAnnotations (i.e. evaluating the previewEntries) and\n        // needs to be show to the user as a simple error\n        _this3.renderPreviewEntryError('Error reading preview.js:', err);\n\n        throw err;\n      });\n    } // If initialization gets as far as project annotations, this function runs.\n\n  }, {\n    key: \"initializeWithProjectAnnotations\",\n    value: function initializeWithProjectAnnotations(projectAnnotations) {\n      var _global$FEATURES2,\n          _this4 = this;\n\n      this.storyStore.setProjectAnnotations(projectAnnotations);\n      this.setInitialGlobals();\n      var storyIndexPromise;\n\n      if ((_global$FEATURES2 = global.FEATURES) !== null && _global$FEATURES2 !== void 0 && _global$FEATURES2.storyStoreV7) {\n        storyIndexPromise = this.getStoryIndexFromServer();\n      } else {\n        if (!this.getStoryIndex) {\n          throw new Error('No `getStoryIndex` passed defined in v6 mode');\n        }\n\n        storyIndexPromise = SynchronousPromise.resolve().then(this.getStoryIndex);\n      }\n\n      return storyIndexPromise.then(function (storyIndex) {\n        return _this4.initializeWithStoryIndex(storyIndex);\n      }).catch(function (err) {\n        _this4.renderPreviewEntryError('Error loading story index:', err);\n\n        throw err;\n      });\n    }\n  }, {\n    key: \"setInitialGlobals\",\n    value: function () {\n      var _setInitialGlobals = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n        var _ref2, globals;\n\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _ref2 = this.urlStore.selectionSpecifier || {}, globals = _ref2.globals;\n\n                if (globals) {\n                  this.storyStore.globals.updateFromPersisted(globals);\n                }\n\n                this.emitGlobals();\n\n              case 3:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function setInitialGlobals() {\n        return _setInitialGlobals.apply(this, arguments);\n      }\n\n      return setInitialGlobals;\n    }()\n  }, {\n    key: \"emitGlobals\",\n    value: function emitGlobals() {\n      this.channel.emit(Events.SET_GLOBALS, {\n        globals: this.storyStore.globals.get() || {},\n        globalTypes: this.storyStore.projectAnnotations.globalTypes || {}\n      });\n    }\n  }, {\n    key: \"getStoryIndexFromServer\",\n    value: function () {\n      var _getStoryIndexFromServer = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {\n        var result;\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                _context2.next = 2;\n                return fetch(STORY_INDEX_PATH);\n\n              case 2:\n                result = _context2.sent;\n\n                if (!(result.status === 200)) {\n                  _context2.next = 5;\n                  break;\n                }\n\n                return _context2.abrupt(\"return\", result.json());\n\n              case 5:\n                _context2.t0 = Error;\n                _context2.next = 8;\n                return result.text();\n\n              case 8:\n                _context2.t1 = _context2.sent;\n                throw new _context2.t0(_context2.t1);\n\n              case 10:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2);\n      }));\n\n      function getStoryIndexFromServer() {\n        return _getStoryIndexFromServer.apply(this, arguments);\n      }\n\n      return getStoryIndexFromServer;\n    }() // If initialization gets as far as the story index, this function runs.\n\n  }, {\n    key: \"initializeWithStoryIndex\",\n    value: function initializeWithStoryIndex(storyIndex) {\n      var _global$FEATURES3,\n          _this5 = this;\n\n      return this.storyStore.initialize({\n        storyIndex: storyIndex,\n        importFn: this.importFn,\n        cache: !((_global$FEATURES3 = global.FEATURES) !== null && _global$FEATURES3 !== void 0 && _global$FEATURES3.storyStoreV7)\n      }).then(function () {\n        var _global$FEATURES4;\n\n        if (!((_global$FEATURES4 = global.FEATURES) !== null && _global$FEATURES4 !== void 0 && _global$FEATURES4.storyStoreV7)) {\n          _this5.channel.emit(Events.SET_STORIES, _this5.storyStore.getSetStoriesPayload());\n        }\n\n        return _this5.selectSpecifiedStory();\n      });\n    } // Use the selection specifier to choose a story, then render it\n\n  }, {\n    key: \"selectSpecifiedStory\",\n    value: function () {\n      var _selectSpecifiedStory = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3() {\n        var _this$urlStore$select, storySpecifier, viewMode, args, storyId;\n\n        return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                if (this.urlStore.selectionSpecifier) {\n                  _context3.next = 3;\n                  break;\n                }\n\n                this.renderMissingStory();\n                return _context3.abrupt(\"return\");\n\n              case 3:\n                _this$urlStore$select = this.urlStore.selectionSpecifier, storySpecifier = _this$urlStore$select.storySpecifier, viewMode = _this$urlStore$select.viewMode, args = _this$urlStore$select.args;\n                storyId = this.storyStore.storyIndex.storyIdFromSpecifier(storySpecifier);\n\n                if (storyId) {\n                  _context3.next = 8;\n                  break;\n                }\n\n                if (storySpecifier === '*') {\n                  this.renderStoryLoadingException(storySpecifier, new Error(dedent(_templateObject3 || (_templateObject3 = _taggedTemplateLiteral([\"\\n            Couldn't find any stories in your Storybook.\\n            - Please check your stories field of your main.js config.\\n            - Also check the browser console and terminal for error messages.\\n          \"])))));\n                } else {\n                  this.renderStoryLoadingException(storySpecifier, new Error(dedent(_templateObject4 || (_templateObject4 = _taggedTemplateLiteral([\"\\n            Couldn't find story matching '\", \"'.\\n            - Are you sure a story with that id exists?\\n            - Please check your stories field of your main.js config.\\n            - Also check the browser console and terminal for error messages.\\n          \"])), storySpecifier)));\n                }\n\n                return _context3.abrupt(\"return\");\n\n              case 8:\n                this.urlStore.setSelection({\n                  storyId: storyId,\n                  viewMode: viewMode\n                });\n                this.channel.emit(Events.STORY_SPECIFIED, this.urlStore.selection);\n                this.channel.emit(Events.CURRENT_STORY_WAS_SET, this.urlStore.selection);\n                _context3.next = 13;\n                return this.renderSelection({\n                  persistedArgs: args\n                });\n\n              case 13:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this);\n      }));\n\n      function selectSpecifiedStory() {\n        return _selectSpecifiedStory.apply(this, arguments);\n      }\n\n      return selectSpecifiedStory;\n    }() // EVENT HANDLERS\n    // This happens when a config file gets reloaded\n\n  }, {\n    key: \"onGetProjectAnnotationsChanged\",\n    value: function () {\n      var _onGetProjectAnnotationsChanged = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4(_ref3) {\n        var getProjectAnnotations, projectAnnotations;\n        return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                getProjectAnnotations = _ref3.getProjectAnnotations;\n                _context4.next = 3;\n                return this.getProjectAnnotationsOrRenderError(getProjectAnnotations);\n\n              case 3:\n                projectAnnotations = _context4.sent;\n\n                if (this.storyStore.projectAnnotations) {\n                  _context4.next = 8;\n                  break;\n                }\n\n                _context4.next = 7;\n                return this.initializeWithProjectAnnotations(projectAnnotations);\n\n              case 7:\n                return _context4.abrupt(\"return\");\n\n              case 8:\n                _context4.next = 10;\n                return this.storyStore.setProjectAnnotations(projectAnnotations);\n\n              case 10:\n                this.emitGlobals();\n                this.renderSelection();\n\n              case 12:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4, this);\n      }));\n\n      function onGetProjectAnnotationsChanged(_x) {\n        return _onGetProjectAnnotationsChanged.apply(this, arguments);\n      }\n\n      return onGetProjectAnnotationsChanged;\n    }()\n  }, {\n    key: \"onStoryIndexChanged\",\n    value: function () {\n      var _onStoryIndexChanged = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee5() {\n        var storyIndex;\n        return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                if (this.storyStore.projectAnnotations) {\n                  _context5.next = 2;\n                  break;\n                }\n\n                return _context5.abrupt(\"return\");\n\n              case 2:\n                _context5.prev = 2;\n                _context5.next = 5;\n                return this.getStoryIndexFromServer();\n\n              case 5:\n                storyIndex = _context5.sent;\n\n                if (this.storyStore.storyIndex) {\n                  _context5.next = 9;\n                  break;\n                }\n\n                _context5.next = 9;\n                return this.initializeWithStoryIndex(storyIndex);\n\n              case 9:\n                _context5.next = 11;\n                return this.onStoriesChanged({\n                  storyIndex: storyIndex\n                });\n\n              case 11:\n                _context5.next = 17;\n                break;\n\n              case 13:\n                _context5.prev = 13;\n                _context5.t0 = _context5[\"catch\"](2);\n                this.renderPreviewEntryError('Error loading story index:', _context5.t0);\n                throw _context5.t0;\n\n              case 17:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5, this, [[2, 13]]);\n      }));\n\n      function onStoryIndexChanged() {\n        return _onStoryIndexChanged.apply(this, arguments);\n      }\n\n      return onStoryIndexChanged;\n    }() // This happens when a glob gets HMR-ed\n\n  }, {\n    key: \"onStoriesChanged\",\n    value: function () {\n      var _onStoriesChanged = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee6(_ref4) {\n        var _global$FEATURES5;\n\n        var importFn, storyIndex;\n        return _regeneratorRuntime.wrap(function _callee6$(_context6) {\n          while (1) {\n            switch (_context6.prev = _context6.next) {\n              case 0:\n                importFn = _ref4.importFn, storyIndex = _ref4.storyIndex;\n                _context6.next = 3;\n                return this.storyStore.onStoriesChanged({\n                  importFn: importFn,\n                  storyIndex: storyIndex\n                });\n\n              case 3:\n                if ((_global$FEATURES5 = global.FEATURES) !== null && _global$FEATURES5 !== void 0 && _global$FEATURES5.storyStoreV7) {\n                  _context6.next = 10;\n                  break;\n                }\n\n                _context6.t0 = this.channel;\n                _context6.t1 = Events.SET_STORIES;\n                _context6.next = 8;\n                return this.storyStore.getSetStoriesPayload();\n\n              case 8:\n                _context6.t2 = _context6.sent;\n\n                _context6.t0.emit.call(_context6.t0, _context6.t1, _context6.t2);\n\n              case 10:\n                if (!this.urlStore.selection) {\n                  _context6.next = 15;\n                  break;\n                }\n\n                _context6.next = 13;\n                return this.renderSelection();\n\n              case 13:\n                _context6.next = 17;\n                break;\n\n              case 15:\n                _context6.next = 17;\n                return this.selectSpecifiedStory();\n\n              case 17:\n              case \"end\":\n                return _context6.stop();\n            }\n          }\n        }, _callee6, this);\n      }));\n\n      function onStoriesChanged(_x2) {\n        return _onStoriesChanged.apply(this, arguments);\n      }\n\n      return onStoriesChanged;\n    }()\n  }, {\n    key: \"onKeydown\",\n    value: function onKeydown(event) {\n      if (!this.disableKeyListeners && !focusInInput(event)) {\n        // We have to pick off the keys of the event that we need on the other side\n        var altKey = event.altKey,\n            ctrlKey = event.ctrlKey,\n            metaKey = event.metaKey,\n            shiftKey = event.shiftKey,\n            key = event.key,\n            code = event.code,\n            keyCode = event.keyCode;\n        this.channel.emit(Events.PREVIEW_KEYDOWN, {\n          event: {\n            altKey: altKey,\n            ctrlKey: ctrlKey,\n            metaKey: metaKey,\n            shiftKey: shiftKey,\n            key: key,\n            code: code,\n            keyCode: keyCode\n          }\n        });\n      }\n    }\n  }, {\n    key: \"onSetCurrentStory\",\n    value: function onSetCurrentStory(selection) {\n      this.urlStore.setSelection(selection);\n      this.channel.emit(Events.CURRENT_STORY_WAS_SET, this.urlStore.selection);\n      this.renderSelection();\n    }\n  }, {\n    key: \"onUpdateQueryParams\",\n    value: function onUpdateQueryParams(queryParams) {\n      this.urlStore.setQueryParams(queryParams);\n    }\n  }, {\n    key: \"onUpdateGlobals\",\n    value: function onUpdateGlobals(_ref5) {\n      var globals = _ref5.globals;\n      this.storyStore.globals.update(globals);\n      this.channel.emit(Events.GLOBALS_UPDATED, {\n        globals: this.storyStore.globals.get(),\n        initialGlobals: this.storyStore.globals.initialGlobals\n      });\n    }\n  }, {\n    key: \"onUpdateArgs\",\n    value: function onUpdateArgs(_ref6) {\n      var storyId = _ref6.storyId,\n          updatedArgs = _ref6.updatedArgs;\n      this.storyStore.args.update(storyId, updatedArgs);\n      this.channel.emit(Events.STORY_ARGS_UPDATED, {\n        storyId: storyId,\n        args: this.storyStore.args.get(storyId)\n      });\n    }\n  }, {\n    key: \"onResetArgs\",\n    value: function () {\n      var _onResetArgs = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee7(_ref7) {\n        var storyId, argNames, _ref8, initialArgs, argNamesToReset, updatedArgs;\n\n        return _regeneratorRuntime.wrap(function _callee7$(_context7) {\n          while (1) {\n            switch (_context7.prev = _context7.next) {\n              case 0:\n                storyId = _ref7.storyId, argNames = _ref7.argNames;\n\n                if (!(storyId === this.previousStory.id)) {\n                  _context7.next = 5;\n                  break;\n                }\n\n                _context7.t0 = this.previousStory;\n                _context7.next = 8;\n                break;\n\n              case 5:\n                _context7.next = 7;\n                return this.storyStore.loadStory({\n                  storyId: storyId\n                });\n\n              case 7:\n                _context7.t0 = _context7.sent;\n\n              case 8:\n                _ref8 = _context7.t0;\n                initialArgs = _ref8.initialArgs;\n                argNamesToReset = argNames || Object.keys(this.storyStore.args.get(storyId));\n                updatedArgs = argNamesToReset.reduce(function (acc, argName) {\n                  acc[argName] = initialArgs[argName];\n                  return acc;\n                }, {});\n                this.onUpdateArgs({\n                  storyId: storyId,\n                  updatedArgs: updatedArgs\n                });\n\n              case 13:\n              case \"end\":\n                return _context7.stop();\n            }\n          }\n        }, _callee7, this);\n      }));\n\n      function onResetArgs(_x3) {\n        return _onResetArgs.apply(this, arguments);\n      }\n\n      return onResetArgs;\n    }() // RENDERING\n    // We can either have:\n    // - a story selected in \"story\" viewMode,\n    //     in which case we render it to the root element, OR\n    // - a story selected in \"docs\" viewMode,\n    //     in which case we render the docsPage for that story\n\n  }, {\n    key: \"renderSelection\",\n    value: function () {\n      var _renderSelection = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee8() {\n        var _this$previousSelecti, _this$previousSelecti2, _global$FEATURES6;\n\n        var _ref9,\n            persistedArgs,\n            selection,\n            storyId,\n            storyIdChanged,\n            viewModeChanged,\n            story,\n            implementationChanged,\n            _this$storyStore$getS,\n            parameters,\n            initialArgs,\n            argTypes,\n            args,\n            _args8 = arguments;\n\n        return _regeneratorRuntime.wrap(function _callee8$(_context8) {\n          while (1) {\n            switch (_context8.prev = _context8.next) {\n              case 0:\n                _ref9 = _args8.length > 0 && _args8[0] !== undefined ? _args8[0] : {}, persistedArgs = _ref9.persistedArgs;\n                selection = this.urlStore.selection;\n\n                if (selection) {\n                  _context8.next = 4;\n                  break;\n                }\n\n                throw new Error('Cannot render story as no selection was made');\n\n              case 4:\n                storyId = selection.storyId;\n                storyIdChanged = ((_this$previousSelecti = this.previousSelection) === null || _this$previousSelecti === void 0 ? void 0 : _this$previousSelecti.storyId) !== storyId;\n                viewModeChanged = ((_this$previousSelecti2 = this.previousSelection) === null || _this$previousSelecti2 === void 0 ? void 0 : _this$previousSelecti2.viewMode) !== selection.viewMode; // Show a spinner while we load the next story\n\n                if (selection.viewMode === 'story') {\n                  this.view.showPreparingStory();\n                } else {\n                  this.view.showPreparingDocs();\n                }\n\n                _context8.prev = 8;\n                _context8.next = 11;\n                return this.storyStore.loadStory({\n                  storyId: storyId\n                });\n\n              case 11:\n                story = _context8.sent;\n                _context8.next = 21;\n                break;\n\n              case 14:\n                _context8.prev = 14;\n                _context8.t0 = _context8[\"catch\"](8);\n                _context8.next = 18;\n                return this.cleanupPreviousRender();\n\n              case 18:\n                this.previousStory = null;\n                this.renderStoryLoadingException(storyId, _context8.t0);\n                return _context8.abrupt(\"return\");\n\n              case 21:\n                implementationChanged = !storyIdChanged && this.previousStory && story !== this.previousStory;\n\n                if (persistedArgs) {\n                  this.storyStore.args.updateFromPersisted(story, persistedArgs);\n                } // Don't re-render the story if nothing has changed to justify it\n\n\n                if (!(this.previousStory && !storyIdChanged && !implementationChanged && !viewModeChanged)) {\n                  _context8.next = 27;\n                  break;\n                }\n\n                this.channel.emit(Events.STORY_UNCHANGED, storyId);\n                this.view.showMain();\n                return _context8.abrupt(\"return\");\n\n              case 27:\n                _context8.next = 29;\n                return this.cleanupPreviousRender({\n                  unmountDocs: viewModeChanged\n                });\n\n              case 29:\n                // If we are rendering something new (as opposed to re-rendering the same or first story), emit\n                if (this.previousSelection && (storyIdChanged || viewModeChanged)) {\n                  this.channel.emit(Events.STORY_CHANGED, storyId);\n                } // Record the previous selection *before* awaiting the rendering, in cases things change before it is done.\n\n\n                this.previousSelection = selection;\n                this.previousStory = story;\n                _this$storyStore$getS = this.storyStore.getStoryContext(story), parameters = _this$storyStore$getS.parameters, initialArgs = _this$storyStore$getS.initialArgs, argTypes = _this$storyStore$getS.argTypes, args = _this$storyStore$getS.args;\n\n                if ((_global$FEATURES6 = global.FEATURES) !== null && _global$FEATURES6 !== void 0 && _global$FEATURES6.storyStoreV7) {\n                  this.channel.emit(Events.STORY_PREPARED, {\n                    id: storyId,\n                    parameters: parameters,\n                    initialArgs: initialArgs,\n                    argTypes: argTypes,\n                    args: args\n                  });\n                } // For v6 mode / compatibility\n                // If the implementation changed, or args were persisted, the args may have changed,\n                // and the STORY_PREPARED event above may not be respected.\n\n\n                if (implementationChanged || persistedArgs) {\n                  this.channel.emit(Events.STORY_ARGS_UPDATED, {\n                    storyId: storyId,\n                    args: args\n                  });\n                }\n\n                if (!(selection.viewMode === 'docs' || story.parameters.docsOnly)) {\n                  _context8.next = 41;\n                  break;\n                }\n\n                _context8.next = 38;\n                return this.renderDocs({\n                  story: story\n                });\n\n              case 38:\n                this.previousCleanup = _context8.sent;\n                _context8.next = 42;\n                break;\n\n              case 41:\n                this.previousCleanup = this.renderStory({\n                  story: story\n                });\n\n              case 42:\n              case \"end\":\n                return _context8.stop();\n            }\n          }\n        }, _callee8, this, [[8, 14]]);\n      }));\n\n      function renderSelection() {\n        return _renderSelection.apply(this, arguments);\n      }\n\n      return renderSelection;\n    }()\n  }, {\n    key: \"renderDocs\",\n    value: function () {\n      var _renderDocs = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee11(_ref10) {\n        var _this6 = this,\n            _global$FEATURES8;\n\n        var story, id, title, name, csfFile, docsContext, render;\n        return _regeneratorRuntime.wrap(function _callee11$(_context11) {\n          while (1) {\n            switch (_context11.prev = _context11.next) {\n              case 0:\n                story = _ref10.story;\n                id = story.id, title = story.title, name = story.name;\n                _context11.next = 4;\n                return this.storyStore.loadCSFFileByStoryId(id);\n\n              case 4:\n                csfFile = _context11.sent;\n                docsContext = {\n                  id: id,\n                  title: title,\n                  name: name,\n                  // NOTE: these two functions are *sync* so cannot access stories from other CSF files\n                  storyById: function storyById(storyId) {\n                    return _this6.storyStore.storyFromCSFFile({\n                      storyId: storyId,\n                      csfFile: csfFile\n                    });\n                  },\n                  componentStories: function componentStories() {\n                    return _this6.storyStore.componentStoriesFromCSFFile({\n                      csfFile: csfFile\n                    });\n                  },\n                  loadStory: function loadStory(storyId) {\n                    return _this6.storyStore.loadStory({\n                      storyId: storyId\n                    });\n                  },\n                  renderStoryToElement: this.renderStoryToElement.bind(this),\n                  getStoryContext: function getStoryContext(renderedStory) {\n                    return Object.assign({}, _this6.storyStore.getStoryContext(renderedStory), {\n                      viewMode: 'docs'\n                    });\n                  }\n                };\n\n                render = /*#__PURE__*/function () {\n                  var _ref11 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee9() {\n                    var _global$FEATURES7;\n\n                    var fullDocsContext, renderer, element;\n                    return _regeneratorRuntime.wrap(function _callee9$(_context9) {\n                      while (1) {\n                        switch (_context9.prev = _context9.next) {\n                          case 0:\n                            fullDocsContext = Object.assign({}, docsContext, !((_global$FEATURES7 = global.FEATURES) !== null && _global$FEATURES7 !== void 0 && _global$FEATURES7.breakingChangesV7) && _this6.storyStore.getStoryContext(story));\n                            _context9.next = 3;\n                            return import('./renderDocs');\n\n                          case 3:\n                            renderer = _context9.sent;\n                            element = _this6.view.prepareForDocs();\n                            renderer.renderDocs(story, fullDocsContext, element, function () {\n                              return _this6.channel.emit(Events.DOCS_RENDERED, id);\n                            });\n\n                          case 6:\n                          case \"end\":\n                            return _context9.stop();\n                        }\n                      }\n                    }, _callee9);\n                  }));\n\n                  return function render() {\n                    return _ref11.apply(this, arguments);\n                  };\n                }(); // Initially render right away\n\n\n                render(); // Listen to events and re-render\n                // NOTE: we aren't checking to see the story args are targetted at the \"right\" story.\n                // This is because we may render >1 story on the page and there is no easy way to keep track\n                // of which ones were rendered by the docs page.\n                // However, in `modernInlineRender`, the individual stories track their own events as they\n                // each call `renderStoryToElement` below.\n\n                if (!((_global$FEATURES8 = global.FEATURES) !== null && _global$FEATURES8 !== void 0 && _global$FEATURES8.modernInlineRender)) {\n                  this.channel.on(Events.UPDATE_GLOBALS, render);\n                  this.channel.on(Events.UPDATE_STORY_ARGS, render);\n                  this.channel.on(Events.RESET_STORY_ARGS, render);\n                }\n\n                return _context11.abrupt(\"return\", /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee10() {\n                  var _global$FEATURES9;\n\n                  return _regeneratorRuntime.wrap(function _callee10$(_context10) {\n                    while (1) {\n                      switch (_context10.prev = _context10.next) {\n                        case 0:\n                          if (!((_global$FEATURES9 = global.FEATURES) !== null && _global$FEATURES9 !== void 0 && _global$FEATURES9.modernInlineRender)) {\n                            _this6.channel.off(Events.UPDATE_GLOBALS, render);\n\n                            _this6.channel.off(Events.UPDATE_STORY_ARGS, render);\n\n                            _this6.channel.off(Events.RESET_STORY_ARGS, render);\n                          }\n\n                        case 1:\n                        case \"end\":\n                          return _context10.stop();\n                      }\n                    }\n                  }, _callee10);\n                })));\n\n              case 10:\n              case \"end\":\n                return _context11.stop();\n            }\n          }\n        }, _callee11, this);\n      }));\n\n      function renderDocs(_x4) {\n        return _renderDocs.apply(this, arguments);\n      }\n\n      return renderDocs;\n    }()\n  }, {\n    key: \"renderStory\",\n    value: function renderStory(_ref13) {\n      var _this7 = this;\n\n      var story = _ref13.story;\n      var element = this.view.prepareForStory(story);\n      var id = story.id,\n          componentId = story.componentId,\n          title = story.title,\n          name = story.name;\n      var renderContext = {\n        componentId: componentId,\n        title: title,\n        kind: title,\n        id: id,\n        name: name,\n        story: name,\n        showMain: function showMain() {\n          return _this7.view.showMain();\n        },\n        showError: function showError(err) {\n          return _this7.renderError(id, err);\n        },\n        showException: function showException(err) {\n          return _this7.renderException(id, err);\n        }\n      };\n      return this.renderStoryToElement({\n        story: story,\n        renderContext: renderContext,\n        element: element\n      });\n    } // Render a story into a given element and watch for the events that would trigger us\n    // to re-render it (plus deal sensibly with things like changing story mid-way through).\n\n  }, {\n    key: \"renderStoryToElement\",\n    value: function renderStoryToElement(_ref14) {\n      var _this8 = this;\n\n      var story = _ref14.story,\n          renderContextWithoutStoryContext = _ref14.renderContext,\n          canvasElement = _ref14.element;\n      var id = story.id,\n          applyLoaders = story.applyLoaders,\n          unboundStoryFn = story.unboundStoryFn,\n          playFunction = story.playFunction;\n      var notYetRendered = true;\n      var phase;\n\n      var isPending = function isPending() {\n        return ['rendering', 'playing'].includes(phase);\n      };\n\n      this.abortController = createController();\n\n      var render = /*#__PURE__*/function () {\n        var _ref15 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee14() {\n          var _ref16,\n              _ref16$initial,\n              initial,\n              _ref16$forceRemount,\n              forceRemount,\n              abortSignal,\n              runPhase,\n              loadedContext,\n              renderStoryContext,\n              renderContext,\n              _args14 = arguments;\n\n          return _regeneratorRuntime.wrap(function _callee14$(_context14) {\n            while (1) {\n              switch (_context14.prev = _context14.next) {\n                case 0:\n                  _ref16 = _args14.length > 0 && _args14[0] !== undefined ? _args14[0] : {}, _ref16$initial = _ref16.initial, initial = _ref16$initial === void 0 ? false : _ref16$initial, _ref16$forceRemount = _ref16.forceRemount, forceRemount = _ref16$forceRemount === void 0 ? false : _ref16$forceRemount;\n\n                  if (forceRemount && !initial) {\n                    _this8.abortController.abort();\n\n                    _this8.abortController = createController();\n                  }\n\n                  abortSignal = _this8.abortController.signal; // we need a stable reference to the signal\n\n                  runPhase = /*#__PURE__*/function () {\n                    var _ref17 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee12(phaseName, phaseFn) {\n                      return _regeneratorRuntime.wrap(function _callee12$(_context12) {\n                        while (1) {\n                          switch (_context12.prev = _context12.next) {\n                            case 0:\n                              phase = phaseName;\n\n                              _this8.channel.emit(Events.STORY_RENDER_PHASE_CHANGED, {\n                                newPhase: phase,\n                                storyId: id\n                              });\n\n                              if (!phaseFn) {\n                                _context12.next = 5;\n                                break;\n                              }\n\n                              _context12.next = 5;\n                              return phaseFn();\n\n                            case 5:\n                              if (abortSignal.aborted) {\n                                phase = 'aborted';\n\n                                _this8.channel.emit(Events.STORY_RENDER_PHASE_CHANGED, {\n                                  newPhase: phase,\n                                  storyId: id\n                                });\n                              }\n\n                            case 6:\n                            case \"end\":\n                              return _context12.stop();\n                          }\n                        }\n                      }, _callee12);\n                    }));\n\n                    return function runPhase(_x5, _x6) {\n                      return _ref17.apply(this, arguments);\n                    };\n                  }();\n\n                  _context14.prev = 4;\n                  _context14.next = 7;\n                  return runPhase('loading', /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee13() {\n                    return _regeneratorRuntime.wrap(function _callee13$(_context13) {\n                      while (1) {\n                        switch (_context13.prev = _context13.next) {\n                          case 0:\n                            _context13.next = 2;\n                            return applyLoaders(Object.assign({}, _this8.storyStore.getStoryContext(story), {\n                              viewMode: canvasElement === _this8.view.storyRoot() ? 'story' : 'docs'\n                            }));\n\n                          case 2:\n                            loadedContext = _context13.sent;\n\n                          case 3:\n                          case \"end\":\n                            return _context13.stop();\n                        }\n                      }\n                    }, _callee13);\n                  })));\n\n                case 7:\n                  if (!abortSignal.aborted) {\n                    _context14.next = 9;\n                    break;\n                  }\n\n                  return _context14.abrupt(\"return\");\n\n                case 9:\n                  renderStoryContext = Object.assign({}, loadedContext, _this8.storyStore.getStoryContext(story), {\n                    abortSignal: abortSignal,\n                    canvasElement: canvasElement\n                  });\n                  renderContext = Object.assign({}, renderContextWithoutStoryContext, {\n                    forceRemount: forceRemount || notYetRendered,\n                    storyContext: renderStoryContext,\n                    storyFn: function storyFn() {\n                      return unboundStoryFn(renderStoryContext);\n                    },\n                    unboundStoryFn: unboundStoryFn\n                  });\n                  _context14.next = 13;\n                  return runPhase('rendering', function () {\n                    return _this8.renderToDOM(renderContext, canvasElement);\n                  });\n\n                case 13:\n                  notYetRendered = false;\n\n                  if (!abortSignal.aborted) {\n                    _context14.next = 16;\n                    break;\n                  }\n\n                  return _context14.abrupt(\"return\");\n\n                case 16:\n                  if (!(forceRemount && playFunction)) {\n                    _context14.next = 25;\n                    break;\n                  }\n\n                  _this8.disableKeyListeners = true;\n                  _context14.next = 20;\n                  return runPhase('playing', function () {\n                    return playFunction(renderContext.storyContext);\n                  });\n\n                case 20:\n                  _context14.next = 22;\n                  return runPhase('played');\n\n                case 22:\n                  _this8.disableKeyListeners = false;\n\n                  if (!abortSignal.aborted) {\n                    _context14.next = 25;\n                    break;\n                  }\n\n                  return _context14.abrupt(\"return\");\n\n                case 25:\n                  _context14.next = 27;\n                  return runPhase('completed', function () {\n                    return _this8.channel.emit(Events.STORY_RENDERED, id);\n                  });\n\n                case 27:\n                  _context14.next = 32;\n                  break;\n\n                case 29:\n                  _context14.prev = 29;\n                  _context14.t0 = _context14[\"catch\"](4);\n                  renderContextWithoutStoryContext.showException(_context14.t0);\n\n                case 32:\n                case \"end\":\n                  return _context14.stop();\n              }\n            }\n          }, _callee14, null, [[4, 29]]);\n        }));\n\n        return function render() {\n          return _ref15.apply(this, arguments);\n        };\n      }(); // Start the first (initial) render. We don't await here because we need to return the \"cleanup\"\n      // function below right away, so if the user changes story during the first render we can cancel\n      // it without having to first wait for it to finish.\n      // Whenever the selection changes we want to force the component to be remounted.\n\n\n      render({\n        initial: true,\n        forceRemount: true\n      });\n\n      var remountStoryIfMatches = function remountStoryIfMatches(_ref19) {\n        var storyId = _ref19.storyId;\n        if (storyId === story.id) render({\n          forceRemount: true\n        });\n      };\n\n      var rerenderStoryIfMatches = function rerenderStoryIfMatches(_ref20) {\n        var storyId = _ref20.storyId;\n        if (storyId === story.id) render();\n      }; // Listen to events and re-render story\n      // Don't forget to unsubscribe on cleanup\n\n\n      this.channel.on(Events.UPDATE_GLOBALS, render);\n      this.channel.on(Events.FORCE_RE_RENDER, render);\n      this.channel.on(Events.FORCE_REMOUNT, remountStoryIfMatches);\n      this.channel.on(Events.UPDATE_STORY_ARGS, rerenderStoryIfMatches);\n      this.channel.on(Events.RESET_STORY_ARGS, rerenderStoryIfMatches); // Cleanup / teardown function invoked on next render (via `cleanupPreviousRender`)\n\n      return /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee15() {\n        return _regeneratorRuntime.wrap(function _callee15$(_context15) {\n          while (1) {\n            switch (_context15.prev = _context15.next) {\n              case 0:\n                // If the story is torn down (either a new story is rendered or the docs page removes it)\n                // we need to consider the fact that the initial render may not be finished\n                // (possibly the loaders or the play function are still running). We use the controller\n                // as a method to abort them, ASAP, but this is not foolproof as we cannot control what\n                // happens inside the user's code.\n                _this8.abortController.abort();\n\n                _this8.storyStore.cleanupStory(story);\n\n                _this8.channel.off(Events.UPDATE_GLOBALS, render);\n\n                _this8.channel.off(Events.FORCE_RE_RENDER, render);\n\n                _this8.channel.off(Events.FORCE_REMOUNT, remountStoryIfMatches);\n\n                _this8.channel.off(Events.UPDATE_STORY_ARGS, rerenderStoryIfMatches);\n\n                _this8.channel.off(Events.RESET_STORY_ARGS, rerenderStoryIfMatches); // Check if we're done rendering/playing. If not, we may have to reload the page.\n\n\n                if (isPending()) {\n                  _context15.next = 9;\n                  break;\n                }\n\n                return _context15.abrupt(\"return\");\n\n              case 9:\n                _context15.next = 11;\n                return new Promise(function (resolve) {\n                  return setTimeout(resolve, 0);\n                });\n\n              case 11:\n                if (isPending()) {\n                  _context15.next = 13;\n                  break;\n                }\n\n                return _context15.abrupt(\"return\");\n\n              case 13:\n                _context15.next = 15;\n                return new Promise(function (resolve) {\n                  return setTimeout(resolve, 0);\n                });\n\n              case 15:\n                if (isPending()) {\n                  _context15.next = 17;\n                  break;\n                }\n\n                return _context15.abrupt(\"return\");\n\n              case 17:\n                _context15.next = 19;\n                return new Promise(function (resolve) {\n                  return setTimeout(resolve, 0);\n                });\n\n              case 19:\n                if (isPending()) {\n                  _context15.next = 21;\n                  break;\n                }\n\n                return _context15.abrupt(\"return\");\n\n              case 21:\n                // If we still haven't completed, reload the page (iframe) to ensure we have a clean slate\n                // for the next render. Since the reload can take a brief moment to happen, we want to stop\n                // further rendering by awaiting a never-resolving promise (which is destroyed on reload).\n                global.window.location.reload();\n                _context15.next = 24;\n                return new Promise(function () {});\n\n              case 24:\n              case \"end\":\n                return _context15.stop();\n            }\n          }\n        }, _callee15);\n      }));\n    }\n  }, {\n    key: \"cleanupPreviousRender\",\n    value: function () {\n      var _cleanupPreviousRender = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee16() {\n        var _this$previousStory, _this$previousStory$p, _this$previousSelecti3;\n\n        var _ref22,\n            _ref22$unmountDocs,\n            unmountDocs,\n            previousViewMode,\n            _args16 = arguments;\n\n        return _regeneratorRuntime.wrap(function _callee16$(_context16) {\n          while (1) {\n            switch (_context16.prev = _context16.next) {\n              case 0:\n                _ref22 = _args16.length > 0 && _args16[0] !== undefined ? _args16[0] : {}, _ref22$unmountDocs = _ref22.unmountDocs, unmountDocs = _ref22$unmountDocs === void 0 ? true : _ref22$unmountDocs;\n                previousViewMode = (_this$previousStory = this.previousStory) !== null && _this$previousStory !== void 0 && (_this$previousStory$p = _this$previousStory.parameters) !== null && _this$previousStory$p !== void 0 && _this$previousStory$p.docsOnly ? 'docs' : (_this$previousSelecti3 = this.previousSelection) === null || _this$previousSelecti3 === void 0 ? void 0 : _this$previousSelecti3.viewMode;\n\n                if (!(unmountDocs && previousViewMode === 'docs')) {\n                  _context16.next = 6;\n                  break;\n                }\n\n                _context16.next = 5;\n                return import('./renderDocs');\n\n              case 5:\n                _context16.sent.unmountDocs(this.view.docsRoot());\n\n              case 6:\n                if (!this.previousCleanup) {\n                  _context16.next = 9;\n                  break;\n                }\n\n                _context16.next = 9;\n                return this.previousCleanup();\n\n              case 9:\n              case \"end\":\n                return _context16.stop();\n            }\n          }\n        }, _callee16, this);\n      }));\n\n      function cleanupPreviousRender() {\n        return _cleanupPreviousRender.apply(this, arguments);\n      }\n\n      return cleanupPreviousRender;\n    }()\n  }, {\n    key: \"renderPreviewEntryError\",\n    value: function renderPreviewEntryError(reason, err) {\n      logger.error(reason);\n      logger.error(err);\n      this.view.showErrorDisplay(err);\n      this.channel.emit(Events.CONFIG_ERROR, err);\n    }\n  }, {\n    key: \"renderMissingStory\",\n    value: function renderMissingStory() {\n      logger.error(\"No story selected\");\n      this.view.showNoPreview();\n      this.channel.emit(Events.STORY_MISSING);\n    }\n  }, {\n    key: \"renderStoryLoadingException\",\n    value: function renderStoryLoadingException(storySpecifier, err) {\n      logger.error(\"Unable to load story '\".concat(storySpecifier, \"':\"));\n      logger.error(err);\n      this.view.showErrorDisplay(err);\n      this.channel.emit(Events.STORY_MISSING, storySpecifier);\n    } // renderException is used if we fail to render the story and it is uncaught by the app layer\n\n  }, {\n    key: \"renderException\",\n    value: function renderException(storyId, err) {\n      this.channel.emit(Events.STORY_THREW_EXCEPTION, err);\n      this.channel.emit(Events.STORY_RENDER_PHASE_CHANGED, {\n        newPhase: 'errored',\n        storyId: storyId\n      }); // Ignored exceptions exist for control flow purposes, and are typically handled elsewhere.\n\n      if (err !== IGNORED_EXCEPTION) {\n        this.view.showErrorDisplay(err);\n        logger.error(\"Error rendering story '\".concat(storyId, \"':\"));\n        logger.error(err);\n      }\n    } // renderError is used by the various app layers to inform the user they have done something\n    // wrong -- for instance returned the wrong thing from a story\n\n  }, {\n    key: \"renderError\",\n    value: function renderError(storyId, _ref23) {\n      var title = _ref23.title,\n          description = _ref23.description;\n      logger.error(\"Error rendering story \".concat(title, \": \").concat(description));\n      this.channel.emit(Events.STORY_ERRORED, {\n        title: title,\n        description: description\n      });\n      this.channel.emit(Events.STORY_RENDER_PHASE_CHANGED, {\n        newPhase: 'errored',\n        storyId: storyId\n      });\n      this.view.showErrorDisplay({\n        message: title,\n        stack: description\n      });\n    }\n  }]);\n\n  return PreviewWeb;\n}();","map":{"version":3,"sources":["/Users/rohitgutal/angular-library-storybook/node_modules/@storybook/preview-web/dist/esm/PreviewWeb.js"],"names":["_templateObject","_templateObject2","_templateObject3","_templateObject4","asyncGeneratorStep","gen","resolve","reject","_next","_throw","key","arg","info","value","error","done","Promise","then","_asyncToGenerator","fn","self","args","arguments","apply","err","undefined","_taggedTemplateLiteral","strings","raw","slice","Object","freeze","defineProperties","_classCallCheck","instance","Constructor","TypeError","_defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","defineProperty","_createClass","protoProps","staticProps","prototype","deprecate","dedent","global","SynchronousPromise","Events","IGNORED_EXCEPTION","logger","addons","StoryStore","UrlStore","WebView","globalWindow","window","AbortController","fetch","focusInInput","event","test","tagName","getAttribute","createController","signal","aborted","abort","STORY_INDEX_PATH","PreviewWeb","_global$FEATURES","_this","channel","serverChannel","urlStore","storyStore","view","getStoryIndex","importFn","renderToDOM","previousSelection","previousStory","previousCleanup","abortController","disableKeyListeners","getChannel","FEATURES","storyStoreV7","hasServerChannel","getServerChannel","getSelection","selection","initialize","_ref","_this2","getProjectAnnotations","setupListeners","getProjectAnnotationsOrRenderError","projectAnnotations","initializeWithProjectAnnotations","_this$serverChannel","onkeydown","onKeydown","bind","on","STORY_INDEX_INVALIDATED","onStoryIndexChanged","SET_CURRENT_STORY","onSetCurrentStory","UPDATE_QUERY_PARAMS","onUpdateQueryParams","UPDATE_GLOBALS","onUpdateGlobals","UPDATE_STORY_ARGS","onUpdateArgs","RESET_STORY_ARGS","onResetArgs","_this3","Error","catch","renderPreviewEntryError","_global$FEATURES2","_this4","setProjectAnnotations","setInitialGlobals","storyIndexPromise","getStoryIndexFromServer","storyIndex","initializeWithStoryIndex","_setInitialGlobals","mark","_callee","_ref2","globals","wrap","_callee$","_context","prev","next","selectionSpecifier","updateFromPersisted","emitGlobals","stop","emit","SET_GLOBALS","get","globalTypes","_getStoryIndexFromServer","_callee2","result","_callee2$","_context2","sent","status","abrupt","json","t0","text","t1","_global$FEATURES3","_this5","cache","_global$FEATURES4","SET_STORIES","getSetStoriesPayload","selectSpecifiedStory","_selectSpecifiedStory","_callee3","_this$urlStore$select","storySpecifier","viewMode","storyId","_callee3$","_context3","renderMissingStory","storyIdFromSpecifier","renderStoryLoadingException","setSelection","STORY_SPECIFIED","CURRENT_STORY_WAS_SET","renderSelection","persistedArgs","_onGetProjectAnnotationsChanged","_callee4","_ref3","_callee4$","_context4","onGetProjectAnnotationsChanged","_x","_onStoryIndexChanged","_callee5","_callee5$","_context5","onStoriesChanged","_onStoriesChanged","_callee6","_ref4","_global$FEATURES5","_callee6$","_context6","t2","call","_x2","altKey","ctrlKey","metaKey","shiftKey","code","keyCode","PREVIEW_KEYDOWN","queryParams","setQueryParams","_ref5","update","GLOBALS_UPDATED","initialGlobals","_ref6","updatedArgs","STORY_ARGS_UPDATED","_onResetArgs","_callee7","_ref7","argNames","_ref8","initialArgs","argNamesToReset","_callee7$","_context7","id","loadStory","keys","reduce","acc","argName","_x3","_renderSelection","_callee8","_this$previousSelecti","_this$previousSelecti2","_global$FEATURES6","_ref9","storyIdChanged","viewModeChanged","story","implementationChanged","_this$storyStore$getS","parameters","argTypes","_args8","_callee8$","_context8","showPreparingStory","showPreparingDocs","cleanupPreviousRender","STORY_UNCHANGED","showMain","unmountDocs","STORY_CHANGED","getStoryContext","STORY_PREPARED","docsOnly","renderDocs","renderStory","_renderDocs","_callee11","_ref10","_this6","_global$FEATURES8","title","name","csfFile","docsContext","render","_callee11$","_context11","loadCSFFileByStoryId","storyById","storyFromCSFFile","componentStories","componentStoriesFromCSFFile","renderStoryToElement","renderedStory","assign","_ref11","_callee9","_global$FEATURES7","fullDocsContext","renderer","element","_callee9$","_context9","breakingChangesV7","prepareForDocs","DOCS_RENDERED","modernInlineRender","_callee10","_global$FEATURES9","_callee10$","_context10","off","_x4","_ref13","_this7","prepareForStory","componentId","renderContext","kind","showError","renderError","showException","renderException","_ref14","_this8","renderContextWithoutStoryContext","canvasElement","applyLoaders","unboundStoryFn","playFunction","notYetRendered","phase","isPending","includes","_ref15","_callee14","_ref16","_ref16$initial","initial","_ref16$forceRemount","forceRemount","abortSignal","runPhase","loadedContext","renderStoryContext","_args14","_callee14$","_context14","_ref17","_callee12","phaseName","phaseFn","_callee12$","_context12","STORY_RENDER_PHASE_CHANGED","newPhase","_x5","_x6","_callee13","_callee13$","_context13","storyRoot","storyContext","storyFn","STORY_RENDERED","remountStoryIfMatches","_ref19","rerenderStoryIfMatches","_ref20","FORCE_RE_RENDER","FORCE_REMOUNT","_callee15","_callee15$","_context15","cleanupStory","setTimeout","location","reload","_cleanupPreviousRender","_callee16","_this$previousStory","_this$previousStory$p","_this$previousSelecti3","_ref22","_ref22$unmountDocs","previousViewMode","_args16","_callee16$","_context16","docsRoot","reason","showErrorDisplay","CONFIG_ERROR","showNoPreview","STORY_MISSING","concat","STORY_THREW_EXCEPTION","_ref23","description","STORY_ERRORED","message","stack"],"mappings":"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","sourcesContent":["import \"core-js/modules/es.array.slice.js\";\nimport \"core-js/modules/es.object.freeze.js\";\n\nvar _templateObject, _templateObject2, _templateObject3, _templateObject4;\n\nimport \"regenerator-runtime/runtime.js\";\n\nfunction asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }\n\nfunction _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"next\", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"throw\", err); } _next(undefined); }); }; }\n\nfunction _taggedTemplateLiteral(strings, raw) { if (!raw) { raw = strings.slice(0); } return Object.freeze(Object.defineProperties(strings, { raw: { value: Object.freeze(raw) } })); }\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nfunction _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }\n\nfunction _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }\n\nimport \"core-js/modules/es.promise.js\";\nimport \"core-js/modules/es.object.to-string.js\";\nimport \"core-js/modules/es.object.keys.js\";\nimport \"core-js/modules/es.function.name.js\";\nimport \"core-js/modules/es.object.assign.js\";\nimport \"core-js/modules/es.array.includes.js\";\nimport \"core-js/modules/es.symbol.js\";\nimport \"core-js/modules/es.symbol.description.js\";\nimport \"core-js/modules/es.array.concat.js\";\nimport deprecate from 'util-deprecate';\nimport dedent from 'ts-dedent';\nimport global from 'global';\nimport { SynchronousPromise } from 'synchronous-promise';\nimport Events, { IGNORED_EXCEPTION } from '@storybook/core-events';\nimport { logger } from '@storybook/client-logger';\nimport { addons } from '@storybook/addons';\nimport { StoryStore } from '@storybook/store';\nimport { UrlStore } from './UrlStore';\nimport { WebView } from './WebView';\nvar globalWindow = global.window,\n    AbortController = global.AbortController,\n    fetch = global.fetch;\n\nfunction focusInInput(event) {\n  var target = event.target;\n  return /input|textarea/i.test(target.tagName) || target.getAttribute('contenteditable') !== null;\n}\n\nfunction createController() {\n  if (AbortController) return new AbortController(); // Polyfill for IE11\n\n  return {\n    signal: {\n      aborted: false\n    },\n    abort: function abort() {\n      this.signal.aborted = true;\n    }\n  };\n}\n\nvar STORY_INDEX_PATH = './stories.json';\nexport var PreviewWeb = /*#__PURE__*/function () {\n  function PreviewWeb() {\n    var _global$FEATURES,\n        _this = this;\n\n    _classCallCheck(this, PreviewWeb);\n\n    this.channel = void 0;\n    this.serverChannel = void 0;\n    this.urlStore = void 0;\n    this.storyStore = void 0;\n    this.view = void 0;\n    this.getStoryIndex = void 0;\n    this.importFn = void 0;\n    this.renderToDOM = void 0;\n    this.previousSelection = void 0;\n    this.previousStory = void 0;\n    this.previousCleanup = void 0;\n    this.abortController = void 0;\n    this.disableKeyListeners = void 0;\n    this.channel = addons.getChannel();\n\n    if ((_global$FEATURES = global.FEATURES) !== null && _global$FEATURES !== void 0 && _global$FEATURES.storyStoreV7 && addons.hasServerChannel()) {\n      this.serverChannel = addons.getServerChannel();\n    }\n\n    this.view = new WebView();\n    this.urlStore = new UrlStore();\n    this.storyStore = new StoryStore(); // Add deprecated APIs for back-compat\n    // @ts-ignore\n\n    this.storyStore.getSelection = deprecate(function () {\n      return _this.urlStore.selection;\n    }, dedent(_templateObject || (_templateObject = _taggedTemplateLiteral([\"\\n        `__STORYBOOK_STORY_STORE__.getSelection()` is deprecated and will be removed in 7.0.\\n  \\n        To get the current selection, use the `useStoryContext()` hook from `@storybook/addons`.\\n      \"], [\"\\n        \\\\`__STORYBOOK_STORY_STORE__.getSelection()\\\\` is deprecated and will be removed in 7.0.\\n  \\n        To get the current selection, use the \\\\`useStoryContext()\\\\` hook from \\\\`@storybook/addons\\\\`.\\n      \"]))));\n  } // INITIALIZATION\n  // NOTE: the reason that the preview and store's initialization code is written in a promise\n  // style and not `async-await`, and the use of `SynchronousPromise`s is in order to allow\n  // storyshots to immediately call `raw()` on the store without waiting for a later tick.\n  // (Even simple things like `Promise.resolve()` and `await` involve the callback happening\n  // in the next promise \"tick\").\n  // See the comment in `storyshots-core/src/api/index.ts` for more detail.\n\n\n  _createClass(PreviewWeb, [{\n    key: \"initialize\",\n    value: function initialize(_ref) {\n      var _this2 = this;\n\n      var getStoryIndex = _ref.getStoryIndex,\n          importFn = _ref.importFn,\n          getProjectAnnotations = _ref.getProjectAnnotations;\n      // We save these two on initialization in case `getProjectAnnotations` errors,\n      // in which case we may need them later when we recover.\n      this.getStoryIndex = getStoryIndex;\n      this.importFn = importFn;\n      this.setupListeners();\n      return this.getProjectAnnotationsOrRenderError(getProjectAnnotations).then(function (projectAnnotations) {\n        return _this2.initializeWithProjectAnnotations(projectAnnotations);\n      });\n    }\n  }, {\n    key: \"setupListeners\",\n    value: function setupListeners() {\n      var _this$serverChannel;\n\n      globalWindow.onkeydown = this.onKeydown.bind(this);\n      (_this$serverChannel = this.serverChannel) === null || _this$serverChannel === void 0 ? void 0 : _this$serverChannel.on(Events.STORY_INDEX_INVALIDATED, this.onStoryIndexChanged.bind(this));\n      this.channel.on(Events.SET_CURRENT_STORY, this.onSetCurrentStory.bind(this));\n      this.channel.on(Events.UPDATE_QUERY_PARAMS, this.onUpdateQueryParams.bind(this));\n      this.channel.on(Events.UPDATE_GLOBALS, this.onUpdateGlobals.bind(this));\n      this.channel.on(Events.UPDATE_STORY_ARGS, this.onUpdateArgs.bind(this));\n      this.channel.on(Events.RESET_STORY_ARGS, this.onResetArgs.bind(this));\n    }\n  }, {\n    key: \"getProjectAnnotationsOrRenderError\",\n    value: function getProjectAnnotationsOrRenderError(getProjectAnnotations) {\n      var _this3 = this;\n\n      return SynchronousPromise.resolve().then(getProjectAnnotations).then(function (projectAnnotations) {\n        _this3.renderToDOM = projectAnnotations.renderToDOM;\n\n        if (!_this3.renderToDOM) {\n          throw new Error(dedent(_templateObject2 || (_templateObject2 = _taggedTemplateLiteral([\"\\n            Expected your framework's preset to export a `renderToDOM` field.\\n\\n            Perhaps it needs to be upgraded for Storybook 6.4?\\n\\n            More info: https://github.com/storybookjs/storybook/blob/next/MIGRATION.md#mainjs-framework-field          \\n          \"], [\"\\n            Expected your framework's preset to export a \\\\`renderToDOM\\\\` field.\\n\\n            Perhaps it needs to be upgraded for Storybook 6.4?\\n\\n            More info: https://github.com/storybookjs/storybook/blob/next/MIGRATION.md#mainjs-framework-field          \\n          \"]))));\n        }\n\n        return projectAnnotations;\n      }).catch(function (err) {\n        // This is an error extracting the projectAnnotations (i.e. evaluating the previewEntries) and\n        // needs to be show to the user as a simple error\n        _this3.renderPreviewEntryError('Error reading preview.js:', err);\n\n        throw err;\n      });\n    } // If initialization gets as far as project annotations, this function runs.\n\n  }, {\n    key: \"initializeWithProjectAnnotations\",\n    value: function initializeWithProjectAnnotations(projectAnnotations) {\n      var _global$FEATURES2,\n          _this4 = this;\n\n      this.storyStore.setProjectAnnotations(projectAnnotations);\n      this.setInitialGlobals();\n      var storyIndexPromise;\n\n      if ((_global$FEATURES2 = global.FEATURES) !== null && _global$FEATURES2 !== void 0 && _global$FEATURES2.storyStoreV7) {\n        storyIndexPromise = this.getStoryIndexFromServer();\n      } else {\n        if (!this.getStoryIndex) {\n          throw new Error('No `getStoryIndex` passed defined in v6 mode');\n        }\n\n        storyIndexPromise = SynchronousPromise.resolve().then(this.getStoryIndex);\n      }\n\n      return storyIndexPromise.then(function (storyIndex) {\n        return _this4.initializeWithStoryIndex(storyIndex);\n      }).catch(function (err) {\n        _this4.renderPreviewEntryError('Error loading story index:', err);\n\n        throw err;\n      });\n    }\n  }, {\n    key: \"setInitialGlobals\",\n    value: function () {\n      var _setInitialGlobals = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee() {\n        var _ref2, globals;\n\n        return regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _ref2 = this.urlStore.selectionSpecifier || {}, globals = _ref2.globals;\n\n                if (globals) {\n                  this.storyStore.globals.updateFromPersisted(globals);\n                }\n\n                this.emitGlobals();\n\n              case 3:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function setInitialGlobals() {\n        return _setInitialGlobals.apply(this, arguments);\n      }\n\n      return setInitialGlobals;\n    }()\n  }, {\n    key: \"emitGlobals\",\n    value: function emitGlobals() {\n      this.channel.emit(Events.SET_GLOBALS, {\n        globals: this.storyStore.globals.get() || {},\n        globalTypes: this.storyStore.projectAnnotations.globalTypes || {}\n      });\n    }\n  }, {\n    key: \"getStoryIndexFromServer\",\n    value: function () {\n      var _getStoryIndexFromServer = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee2() {\n        var result;\n        return regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                _context2.next = 2;\n                return fetch(STORY_INDEX_PATH);\n\n              case 2:\n                result = _context2.sent;\n\n                if (!(result.status === 200)) {\n                  _context2.next = 5;\n                  break;\n                }\n\n                return _context2.abrupt(\"return\", result.json());\n\n              case 5:\n                _context2.t0 = Error;\n                _context2.next = 8;\n                return result.text();\n\n              case 8:\n                _context2.t1 = _context2.sent;\n                throw new _context2.t0(_context2.t1);\n\n              case 10:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2);\n      }));\n\n      function getStoryIndexFromServer() {\n        return _getStoryIndexFromServer.apply(this, arguments);\n      }\n\n      return getStoryIndexFromServer;\n    }() // If initialization gets as far as the story index, this function runs.\n\n  }, {\n    key: \"initializeWithStoryIndex\",\n    value: function initializeWithStoryIndex(storyIndex) {\n      var _global$FEATURES3,\n          _this5 = this;\n\n      return this.storyStore.initialize({\n        storyIndex: storyIndex,\n        importFn: this.importFn,\n        cache: !((_global$FEATURES3 = global.FEATURES) !== null && _global$FEATURES3 !== void 0 && _global$FEATURES3.storyStoreV7)\n      }).then(function () {\n        var _global$FEATURES4;\n\n        if (!((_global$FEATURES4 = global.FEATURES) !== null && _global$FEATURES4 !== void 0 && _global$FEATURES4.storyStoreV7)) {\n          _this5.channel.emit(Events.SET_STORIES, _this5.storyStore.getSetStoriesPayload());\n        }\n\n        return _this5.selectSpecifiedStory();\n      });\n    } // Use the selection specifier to choose a story, then render it\n\n  }, {\n    key: \"selectSpecifiedStory\",\n    value: function () {\n      var _selectSpecifiedStory = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee3() {\n        var _this$urlStore$select, storySpecifier, viewMode, args, storyId;\n\n        return regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                if (this.urlStore.selectionSpecifier) {\n                  _context3.next = 3;\n                  break;\n                }\n\n                this.renderMissingStory();\n                return _context3.abrupt(\"return\");\n\n              case 3:\n                _this$urlStore$select = this.urlStore.selectionSpecifier, storySpecifier = _this$urlStore$select.storySpecifier, viewMode = _this$urlStore$select.viewMode, args = _this$urlStore$select.args;\n                storyId = this.storyStore.storyIndex.storyIdFromSpecifier(storySpecifier);\n\n                if (storyId) {\n                  _context3.next = 8;\n                  break;\n                }\n\n                if (storySpecifier === '*') {\n                  this.renderStoryLoadingException(storySpecifier, new Error(dedent(_templateObject3 || (_templateObject3 = _taggedTemplateLiteral([\"\\n            Couldn't find any stories in your Storybook.\\n            - Please check your stories field of your main.js config.\\n            - Also check the browser console and terminal for error messages.\\n          \"])))));\n                } else {\n                  this.renderStoryLoadingException(storySpecifier, new Error(dedent(_templateObject4 || (_templateObject4 = _taggedTemplateLiteral([\"\\n            Couldn't find story matching '\", \"'.\\n            - Are you sure a story with that id exists?\\n            - Please check your stories field of your main.js config.\\n            - Also check the browser console and terminal for error messages.\\n          \"])), storySpecifier)));\n                }\n\n                return _context3.abrupt(\"return\");\n\n              case 8:\n                this.urlStore.setSelection({\n                  storyId: storyId,\n                  viewMode: viewMode\n                });\n                this.channel.emit(Events.STORY_SPECIFIED, this.urlStore.selection);\n                this.channel.emit(Events.CURRENT_STORY_WAS_SET, this.urlStore.selection);\n                _context3.next = 13;\n                return this.renderSelection({\n                  persistedArgs: args\n                });\n\n              case 13:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this);\n      }));\n\n      function selectSpecifiedStory() {\n        return _selectSpecifiedStory.apply(this, arguments);\n      }\n\n      return selectSpecifiedStory;\n    }() // EVENT HANDLERS\n    // This happens when a config file gets reloaded\n\n  }, {\n    key: \"onGetProjectAnnotationsChanged\",\n    value: function () {\n      var _onGetProjectAnnotationsChanged = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee4(_ref3) {\n        var getProjectAnnotations, projectAnnotations;\n        return regeneratorRuntime.wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                getProjectAnnotations = _ref3.getProjectAnnotations;\n                _context4.next = 3;\n                return this.getProjectAnnotationsOrRenderError(getProjectAnnotations);\n\n              case 3:\n                projectAnnotations = _context4.sent;\n\n                if (this.storyStore.projectAnnotations) {\n                  _context4.next = 8;\n                  break;\n                }\n\n                _context4.next = 7;\n                return this.initializeWithProjectAnnotations(projectAnnotations);\n\n              case 7:\n                return _context4.abrupt(\"return\");\n\n              case 8:\n                _context4.next = 10;\n                return this.storyStore.setProjectAnnotations(projectAnnotations);\n\n              case 10:\n                this.emitGlobals();\n                this.renderSelection();\n\n              case 12:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4, this);\n      }));\n\n      function onGetProjectAnnotationsChanged(_x) {\n        return _onGetProjectAnnotationsChanged.apply(this, arguments);\n      }\n\n      return onGetProjectAnnotationsChanged;\n    }()\n  }, {\n    key: \"onStoryIndexChanged\",\n    value: function () {\n      var _onStoryIndexChanged = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee5() {\n        var storyIndex;\n        return regeneratorRuntime.wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                if (this.storyStore.projectAnnotations) {\n                  _context5.next = 2;\n                  break;\n                }\n\n                return _context5.abrupt(\"return\");\n\n              case 2:\n                _context5.prev = 2;\n                _context5.next = 5;\n                return this.getStoryIndexFromServer();\n\n              case 5:\n                storyIndex = _context5.sent;\n\n                if (this.storyStore.storyIndex) {\n                  _context5.next = 9;\n                  break;\n                }\n\n                _context5.next = 9;\n                return this.initializeWithStoryIndex(storyIndex);\n\n              case 9:\n                _context5.next = 11;\n                return this.onStoriesChanged({\n                  storyIndex: storyIndex\n                });\n\n              case 11:\n                _context5.next = 17;\n                break;\n\n              case 13:\n                _context5.prev = 13;\n                _context5.t0 = _context5[\"catch\"](2);\n                this.renderPreviewEntryError('Error loading story index:', _context5.t0);\n                throw _context5.t0;\n\n              case 17:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5, this, [[2, 13]]);\n      }));\n\n      function onStoryIndexChanged() {\n        return _onStoryIndexChanged.apply(this, arguments);\n      }\n\n      return onStoryIndexChanged;\n    }() // This happens when a glob gets HMR-ed\n\n  }, {\n    key: \"onStoriesChanged\",\n    value: function () {\n      var _onStoriesChanged = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee6(_ref4) {\n        var _global$FEATURES5;\n\n        var importFn, storyIndex;\n        return regeneratorRuntime.wrap(function _callee6$(_context6) {\n          while (1) {\n            switch (_context6.prev = _context6.next) {\n              case 0:\n                importFn = _ref4.importFn, storyIndex = _ref4.storyIndex;\n                _context6.next = 3;\n                return this.storyStore.onStoriesChanged({\n                  importFn: importFn,\n                  storyIndex: storyIndex\n                });\n\n              case 3:\n                if ((_global$FEATURES5 = global.FEATURES) !== null && _global$FEATURES5 !== void 0 && _global$FEATURES5.storyStoreV7) {\n                  _context6.next = 10;\n                  break;\n                }\n\n                _context6.t0 = this.channel;\n                _context6.t1 = Events.SET_STORIES;\n                _context6.next = 8;\n                return this.storyStore.getSetStoriesPayload();\n\n              case 8:\n                _context6.t2 = _context6.sent;\n\n                _context6.t0.emit.call(_context6.t0, _context6.t1, _context6.t2);\n\n              case 10:\n                if (!this.urlStore.selection) {\n                  _context6.next = 15;\n                  break;\n                }\n\n                _context6.next = 13;\n                return this.renderSelection();\n\n              case 13:\n                _context6.next = 17;\n                break;\n\n              case 15:\n                _context6.next = 17;\n                return this.selectSpecifiedStory();\n\n              case 17:\n              case \"end\":\n                return _context6.stop();\n            }\n          }\n        }, _callee6, this);\n      }));\n\n      function onStoriesChanged(_x2) {\n        return _onStoriesChanged.apply(this, arguments);\n      }\n\n      return onStoriesChanged;\n    }()\n  }, {\n    key: \"onKeydown\",\n    value: function onKeydown(event) {\n      if (!this.disableKeyListeners && !focusInInput(event)) {\n        // We have to pick off the keys of the event that we need on the other side\n        var altKey = event.altKey,\n            ctrlKey = event.ctrlKey,\n            metaKey = event.metaKey,\n            shiftKey = event.shiftKey,\n            key = event.key,\n            code = event.code,\n            keyCode = event.keyCode;\n        this.channel.emit(Events.PREVIEW_KEYDOWN, {\n          event: {\n            altKey: altKey,\n            ctrlKey: ctrlKey,\n            metaKey: metaKey,\n            shiftKey: shiftKey,\n            key: key,\n            code: code,\n            keyCode: keyCode\n          }\n        });\n      }\n    }\n  }, {\n    key: \"onSetCurrentStory\",\n    value: function onSetCurrentStory(selection) {\n      this.urlStore.setSelection(selection);\n      this.channel.emit(Events.CURRENT_STORY_WAS_SET, this.urlStore.selection);\n      this.renderSelection();\n    }\n  }, {\n    key: \"onUpdateQueryParams\",\n    value: function onUpdateQueryParams(queryParams) {\n      this.urlStore.setQueryParams(queryParams);\n    }\n  }, {\n    key: \"onUpdateGlobals\",\n    value: function onUpdateGlobals(_ref5) {\n      var globals = _ref5.globals;\n      this.storyStore.globals.update(globals);\n      this.channel.emit(Events.GLOBALS_UPDATED, {\n        globals: this.storyStore.globals.get(),\n        initialGlobals: this.storyStore.globals.initialGlobals\n      });\n    }\n  }, {\n    key: \"onUpdateArgs\",\n    value: function onUpdateArgs(_ref6) {\n      var storyId = _ref6.storyId,\n          updatedArgs = _ref6.updatedArgs;\n      this.storyStore.args.update(storyId, updatedArgs);\n      this.channel.emit(Events.STORY_ARGS_UPDATED, {\n        storyId: storyId,\n        args: this.storyStore.args.get(storyId)\n      });\n    }\n  }, {\n    key: \"onResetArgs\",\n    value: function () {\n      var _onResetArgs = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee7(_ref7) {\n        var storyId, argNames, _ref8, initialArgs, argNamesToReset, updatedArgs;\n\n        return regeneratorRuntime.wrap(function _callee7$(_context7) {\n          while (1) {\n            switch (_context7.prev = _context7.next) {\n              case 0:\n                storyId = _ref7.storyId, argNames = _ref7.argNames;\n\n                if (!(storyId === this.previousStory.id)) {\n                  _context7.next = 5;\n                  break;\n                }\n\n                _context7.t0 = this.previousStory;\n                _context7.next = 8;\n                break;\n\n              case 5:\n                _context7.next = 7;\n                return this.storyStore.loadStory({\n                  storyId: storyId\n                });\n\n              case 7:\n                _context7.t0 = _context7.sent;\n\n              case 8:\n                _ref8 = _context7.t0;\n                initialArgs = _ref8.initialArgs;\n                argNamesToReset = argNames || Object.keys(this.storyStore.args.get(storyId));\n                updatedArgs = argNamesToReset.reduce(function (acc, argName) {\n                  acc[argName] = initialArgs[argName];\n                  return acc;\n                }, {});\n                this.onUpdateArgs({\n                  storyId: storyId,\n                  updatedArgs: updatedArgs\n                });\n\n              case 13:\n              case \"end\":\n                return _context7.stop();\n            }\n          }\n        }, _callee7, this);\n      }));\n\n      function onResetArgs(_x3) {\n        return _onResetArgs.apply(this, arguments);\n      }\n\n      return onResetArgs;\n    }() // RENDERING\n    // We can either have:\n    // - a story selected in \"story\" viewMode,\n    //     in which case we render it to the root element, OR\n    // - a story selected in \"docs\" viewMode,\n    //     in which case we render the docsPage for that story\n\n  }, {\n    key: \"renderSelection\",\n    value: function () {\n      var _renderSelection = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee8() {\n        var _this$previousSelecti, _this$previousSelecti2, _global$FEATURES6;\n\n        var _ref9,\n            persistedArgs,\n            selection,\n            storyId,\n            storyIdChanged,\n            viewModeChanged,\n            story,\n            implementationChanged,\n            _this$storyStore$getS,\n            parameters,\n            initialArgs,\n            argTypes,\n            args,\n            _args8 = arguments;\n\n        return regeneratorRuntime.wrap(function _callee8$(_context8) {\n          while (1) {\n            switch (_context8.prev = _context8.next) {\n              case 0:\n                _ref9 = _args8.length > 0 && _args8[0] !== undefined ? _args8[0] : {}, persistedArgs = _ref9.persistedArgs;\n                selection = this.urlStore.selection;\n\n                if (selection) {\n                  _context8.next = 4;\n                  break;\n                }\n\n                throw new Error('Cannot render story as no selection was made');\n\n              case 4:\n                storyId = selection.storyId;\n                storyIdChanged = ((_this$previousSelecti = this.previousSelection) === null || _this$previousSelecti === void 0 ? void 0 : _this$previousSelecti.storyId) !== storyId;\n                viewModeChanged = ((_this$previousSelecti2 = this.previousSelection) === null || _this$previousSelecti2 === void 0 ? void 0 : _this$previousSelecti2.viewMode) !== selection.viewMode; // Show a spinner while we load the next story\n\n                if (selection.viewMode === 'story') {\n                  this.view.showPreparingStory();\n                } else {\n                  this.view.showPreparingDocs();\n                }\n\n                _context8.prev = 8;\n                _context8.next = 11;\n                return this.storyStore.loadStory({\n                  storyId: storyId\n                });\n\n              case 11:\n                story = _context8.sent;\n                _context8.next = 21;\n                break;\n\n              case 14:\n                _context8.prev = 14;\n                _context8.t0 = _context8[\"catch\"](8);\n                _context8.next = 18;\n                return this.cleanupPreviousRender();\n\n              case 18:\n                this.previousStory = null;\n                this.renderStoryLoadingException(storyId, _context8.t0);\n                return _context8.abrupt(\"return\");\n\n              case 21:\n                implementationChanged = !storyIdChanged && this.previousStory && story !== this.previousStory;\n\n                if (persistedArgs) {\n                  this.storyStore.args.updateFromPersisted(story, persistedArgs);\n                } // Don't re-render the story if nothing has changed to justify it\n\n\n                if (!(this.previousStory && !storyIdChanged && !implementationChanged && !viewModeChanged)) {\n                  _context8.next = 27;\n                  break;\n                }\n\n                this.channel.emit(Events.STORY_UNCHANGED, storyId);\n                this.view.showMain();\n                return _context8.abrupt(\"return\");\n\n              case 27:\n                _context8.next = 29;\n                return this.cleanupPreviousRender({\n                  unmountDocs: viewModeChanged\n                });\n\n              case 29:\n                // If we are rendering something new (as opposed to re-rendering the same or first story), emit\n                if (this.previousSelection && (storyIdChanged || viewModeChanged)) {\n                  this.channel.emit(Events.STORY_CHANGED, storyId);\n                } // Record the previous selection *before* awaiting the rendering, in cases things change before it is done.\n\n\n                this.previousSelection = selection;\n                this.previousStory = story;\n                _this$storyStore$getS = this.storyStore.getStoryContext(story), parameters = _this$storyStore$getS.parameters, initialArgs = _this$storyStore$getS.initialArgs, argTypes = _this$storyStore$getS.argTypes, args = _this$storyStore$getS.args;\n\n                if ((_global$FEATURES6 = global.FEATURES) !== null && _global$FEATURES6 !== void 0 && _global$FEATURES6.storyStoreV7) {\n                  this.channel.emit(Events.STORY_PREPARED, {\n                    id: storyId,\n                    parameters: parameters,\n                    initialArgs: initialArgs,\n                    argTypes: argTypes,\n                    args: args\n                  });\n                } // For v6 mode / compatibility\n                // If the implementation changed, or args were persisted, the args may have changed,\n                // and the STORY_PREPARED event above may not be respected.\n\n\n                if (implementationChanged || persistedArgs) {\n                  this.channel.emit(Events.STORY_ARGS_UPDATED, {\n                    storyId: storyId,\n                    args: args\n                  });\n                }\n\n                if (!(selection.viewMode === 'docs' || story.parameters.docsOnly)) {\n                  _context8.next = 41;\n                  break;\n                }\n\n                _context8.next = 38;\n                return this.renderDocs({\n                  story: story\n                });\n\n              case 38:\n                this.previousCleanup = _context8.sent;\n                _context8.next = 42;\n                break;\n\n              case 41:\n                this.previousCleanup = this.renderStory({\n                  story: story\n                });\n\n              case 42:\n              case \"end\":\n                return _context8.stop();\n            }\n          }\n        }, _callee8, this, [[8, 14]]);\n      }));\n\n      function renderSelection() {\n        return _renderSelection.apply(this, arguments);\n      }\n\n      return renderSelection;\n    }()\n  }, {\n    key: \"renderDocs\",\n    value: function () {\n      var _renderDocs = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee11(_ref10) {\n        var _this6 = this,\n            _global$FEATURES8;\n\n        var story, id, title, name, csfFile, docsContext, render;\n        return regeneratorRuntime.wrap(function _callee11$(_context11) {\n          while (1) {\n            switch (_context11.prev = _context11.next) {\n              case 0:\n                story = _ref10.story;\n                id = story.id, title = story.title, name = story.name;\n                _context11.next = 4;\n                return this.storyStore.loadCSFFileByStoryId(id);\n\n              case 4:\n                csfFile = _context11.sent;\n                docsContext = {\n                  id: id,\n                  title: title,\n                  name: name,\n                  // NOTE: these two functions are *sync* so cannot access stories from other CSF files\n                  storyById: function storyById(storyId) {\n                    return _this6.storyStore.storyFromCSFFile({\n                      storyId: storyId,\n                      csfFile: csfFile\n                    });\n                  },\n                  componentStories: function componentStories() {\n                    return _this6.storyStore.componentStoriesFromCSFFile({\n                      csfFile: csfFile\n                    });\n                  },\n                  loadStory: function loadStory(storyId) {\n                    return _this6.storyStore.loadStory({\n                      storyId: storyId\n                    });\n                  },\n                  renderStoryToElement: this.renderStoryToElement.bind(this),\n                  getStoryContext: function getStoryContext(renderedStory) {\n                    return Object.assign({}, _this6.storyStore.getStoryContext(renderedStory), {\n                      viewMode: 'docs'\n                    });\n                  }\n                };\n\n                render = /*#__PURE__*/function () {\n                  var _ref11 = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee9() {\n                    var _global$FEATURES7;\n\n                    var fullDocsContext, renderer, element;\n                    return regeneratorRuntime.wrap(function _callee9$(_context9) {\n                      while (1) {\n                        switch (_context9.prev = _context9.next) {\n                          case 0:\n                            fullDocsContext = Object.assign({}, docsContext, !((_global$FEATURES7 = global.FEATURES) !== null && _global$FEATURES7 !== void 0 && _global$FEATURES7.breakingChangesV7) && _this6.storyStore.getStoryContext(story));\n                            _context9.next = 3;\n                            return import('./renderDocs');\n\n                          case 3:\n                            renderer = _context9.sent;\n                            element = _this6.view.prepareForDocs();\n                            renderer.renderDocs(story, fullDocsContext, element, function () {\n                              return _this6.channel.emit(Events.DOCS_RENDERED, id);\n                            });\n\n                          case 6:\n                          case \"end\":\n                            return _context9.stop();\n                        }\n                      }\n                    }, _callee9);\n                  }));\n\n                  return function render() {\n                    return _ref11.apply(this, arguments);\n                  };\n                }(); // Initially render right away\n\n\n                render(); // Listen to events and re-render\n                // NOTE: we aren't checking to see the story args are targetted at the \"right\" story.\n                // This is because we may render >1 story on the page and there is no easy way to keep track\n                // of which ones were rendered by the docs page.\n                // However, in `modernInlineRender`, the individual stories track their own events as they\n                // each call `renderStoryToElement` below.\n\n                if (!((_global$FEATURES8 = global.FEATURES) !== null && _global$FEATURES8 !== void 0 && _global$FEATURES8.modernInlineRender)) {\n                  this.channel.on(Events.UPDATE_GLOBALS, render);\n                  this.channel.on(Events.UPDATE_STORY_ARGS, render);\n                  this.channel.on(Events.RESET_STORY_ARGS, render);\n                }\n\n                return _context11.abrupt(\"return\", /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee10() {\n                  var _global$FEATURES9;\n\n                  return regeneratorRuntime.wrap(function _callee10$(_context10) {\n                    while (1) {\n                      switch (_context10.prev = _context10.next) {\n                        case 0:\n                          if (!((_global$FEATURES9 = global.FEATURES) !== null && _global$FEATURES9 !== void 0 && _global$FEATURES9.modernInlineRender)) {\n                            _this6.channel.off(Events.UPDATE_GLOBALS, render);\n\n                            _this6.channel.off(Events.UPDATE_STORY_ARGS, render);\n\n                            _this6.channel.off(Events.RESET_STORY_ARGS, render);\n                          }\n\n                        case 1:\n                        case \"end\":\n                          return _context10.stop();\n                      }\n                    }\n                  }, _callee10);\n                })));\n\n              case 10:\n              case \"end\":\n                return _context11.stop();\n            }\n          }\n        }, _callee11, this);\n      }));\n\n      function renderDocs(_x4) {\n        return _renderDocs.apply(this, arguments);\n      }\n\n      return renderDocs;\n    }()\n  }, {\n    key: \"renderStory\",\n    value: function renderStory(_ref13) {\n      var _this7 = this;\n\n      var story = _ref13.story;\n      var element = this.view.prepareForStory(story);\n      var id = story.id,\n          componentId = story.componentId,\n          title = story.title,\n          name = story.name;\n      var renderContext = {\n        componentId: componentId,\n        title: title,\n        kind: title,\n        id: id,\n        name: name,\n        story: name,\n        showMain: function showMain() {\n          return _this7.view.showMain();\n        },\n        showError: function showError(err) {\n          return _this7.renderError(id, err);\n        },\n        showException: function showException(err) {\n          return _this7.renderException(id, err);\n        }\n      };\n      return this.renderStoryToElement({\n        story: story,\n        renderContext: renderContext,\n        element: element\n      });\n    } // Render a story into a given element and watch for the events that would trigger us\n    // to re-render it (plus deal sensibly with things like changing story mid-way through).\n\n  }, {\n    key: \"renderStoryToElement\",\n    value: function renderStoryToElement(_ref14) {\n      var _this8 = this;\n\n      var story = _ref14.story,\n          renderContextWithoutStoryContext = _ref14.renderContext,\n          canvasElement = _ref14.element;\n      var id = story.id,\n          applyLoaders = story.applyLoaders,\n          unboundStoryFn = story.unboundStoryFn,\n          playFunction = story.playFunction;\n      var notYetRendered = true;\n      var phase;\n\n      var isPending = function isPending() {\n        return ['rendering', 'playing'].includes(phase);\n      };\n\n      this.abortController = createController();\n\n      var render = /*#__PURE__*/function () {\n        var _ref15 = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee14() {\n          var _ref16,\n              _ref16$initial,\n              initial,\n              _ref16$forceRemount,\n              forceRemount,\n              abortSignal,\n              runPhase,\n              loadedContext,\n              renderStoryContext,\n              renderContext,\n              _args14 = arguments;\n\n          return regeneratorRuntime.wrap(function _callee14$(_context14) {\n            while (1) {\n              switch (_context14.prev = _context14.next) {\n                case 0:\n                  _ref16 = _args14.length > 0 && _args14[0] !== undefined ? _args14[0] : {}, _ref16$initial = _ref16.initial, initial = _ref16$initial === void 0 ? false : _ref16$initial, _ref16$forceRemount = _ref16.forceRemount, forceRemount = _ref16$forceRemount === void 0 ? false : _ref16$forceRemount;\n\n                  if (forceRemount && !initial) {\n                    _this8.abortController.abort();\n\n                    _this8.abortController = createController();\n                  }\n\n                  abortSignal = _this8.abortController.signal; // we need a stable reference to the signal\n\n                  runPhase = /*#__PURE__*/function () {\n                    var _ref17 = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee12(phaseName, phaseFn) {\n                      return regeneratorRuntime.wrap(function _callee12$(_context12) {\n                        while (1) {\n                          switch (_context12.prev = _context12.next) {\n                            case 0:\n                              phase = phaseName;\n\n                              _this8.channel.emit(Events.STORY_RENDER_PHASE_CHANGED, {\n                                newPhase: phase,\n                                storyId: id\n                              });\n\n                              if (!phaseFn) {\n                                _context12.next = 5;\n                                break;\n                              }\n\n                              _context12.next = 5;\n                              return phaseFn();\n\n                            case 5:\n                              if (abortSignal.aborted) {\n                                phase = 'aborted';\n\n                                _this8.channel.emit(Events.STORY_RENDER_PHASE_CHANGED, {\n                                  newPhase: phase,\n                                  storyId: id\n                                });\n                              }\n\n                            case 6:\n                            case \"end\":\n                              return _context12.stop();\n                          }\n                        }\n                      }, _callee12);\n                    }));\n\n                    return function runPhase(_x5, _x6) {\n                      return _ref17.apply(this, arguments);\n                    };\n                  }();\n\n                  _context14.prev = 4;\n                  _context14.next = 7;\n                  return runPhase('loading', /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee13() {\n                    return regeneratorRuntime.wrap(function _callee13$(_context13) {\n                      while (1) {\n                        switch (_context13.prev = _context13.next) {\n                          case 0:\n                            _context13.next = 2;\n                            return applyLoaders(Object.assign({}, _this8.storyStore.getStoryContext(story), {\n                              viewMode: canvasElement === _this8.view.storyRoot() ? 'story' : 'docs'\n                            }));\n\n                          case 2:\n                            loadedContext = _context13.sent;\n\n                          case 3:\n                          case \"end\":\n                            return _context13.stop();\n                        }\n                      }\n                    }, _callee13);\n                  })));\n\n                case 7:\n                  if (!abortSignal.aborted) {\n                    _context14.next = 9;\n                    break;\n                  }\n\n                  return _context14.abrupt(\"return\");\n\n                case 9:\n                  renderStoryContext = Object.assign({}, loadedContext, _this8.storyStore.getStoryContext(story), {\n                    abortSignal: abortSignal,\n                    canvasElement: canvasElement\n                  });\n                  renderContext = Object.assign({}, renderContextWithoutStoryContext, {\n                    forceRemount: forceRemount || notYetRendered,\n                    storyContext: renderStoryContext,\n                    storyFn: function storyFn() {\n                      return unboundStoryFn(renderStoryContext);\n                    },\n                    unboundStoryFn: unboundStoryFn\n                  });\n                  _context14.next = 13;\n                  return runPhase('rendering', function () {\n                    return _this8.renderToDOM(renderContext, canvasElement);\n                  });\n\n                case 13:\n                  notYetRendered = false;\n\n                  if (!abortSignal.aborted) {\n                    _context14.next = 16;\n                    break;\n                  }\n\n                  return _context14.abrupt(\"return\");\n\n                case 16:\n                  if (!(forceRemount && playFunction)) {\n                    _context14.next = 25;\n                    break;\n                  }\n\n                  _this8.disableKeyListeners = true;\n                  _context14.next = 20;\n                  return runPhase('playing', function () {\n                    return playFunction(renderContext.storyContext);\n                  });\n\n                case 20:\n                  _context14.next = 22;\n                  return runPhase('played');\n\n                case 22:\n                  _this8.disableKeyListeners = false;\n\n                  if (!abortSignal.aborted) {\n                    _context14.next = 25;\n                    break;\n                  }\n\n                  return _context14.abrupt(\"return\");\n\n                case 25:\n                  _context14.next = 27;\n                  return runPhase('completed', function () {\n                    return _this8.channel.emit(Events.STORY_RENDERED, id);\n                  });\n\n                case 27:\n                  _context14.next = 32;\n                  break;\n\n                case 29:\n                  _context14.prev = 29;\n                  _context14.t0 = _context14[\"catch\"](4);\n                  renderContextWithoutStoryContext.showException(_context14.t0);\n\n                case 32:\n                case \"end\":\n                  return _context14.stop();\n              }\n            }\n          }, _callee14, null, [[4, 29]]);\n        }));\n\n        return function render() {\n          return _ref15.apply(this, arguments);\n        };\n      }(); // Start the first (initial) render. We don't await here because we need to return the \"cleanup\"\n      // function below right away, so if the user changes story during the first render we can cancel\n      // it without having to first wait for it to finish.\n      // Whenever the selection changes we want to force the component to be remounted.\n\n\n      render({\n        initial: true,\n        forceRemount: true\n      });\n\n      var remountStoryIfMatches = function remountStoryIfMatches(_ref19) {\n        var storyId = _ref19.storyId;\n        if (storyId === story.id) render({\n          forceRemount: true\n        });\n      };\n\n      var rerenderStoryIfMatches = function rerenderStoryIfMatches(_ref20) {\n        var storyId = _ref20.storyId;\n        if (storyId === story.id) render();\n      }; // Listen to events and re-render story\n      // Don't forget to unsubscribe on cleanup\n\n\n      this.channel.on(Events.UPDATE_GLOBALS, render);\n      this.channel.on(Events.FORCE_RE_RENDER, render);\n      this.channel.on(Events.FORCE_REMOUNT, remountStoryIfMatches);\n      this.channel.on(Events.UPDATE_STORY_ARGS, rerenderStoryIfMatches);\n      this.channel.on(Events.RESET_STORY_ARGS, rerenderStoryIfMatches); // Cleanup / teardown function invoked on next render (via `cleanupPreviousRender`)\n\n      return /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee15() {\n        return regeneratorRuntime.wrap(function _callee15$(_context15) {\n          while (1) {\n            switch (_context15.prev = _context15.next) {\n              case 0:\n                // If the story is torn down (either a new story is rendered or the docs page removes it)\n                // we need to consider the fact that the initial render may not be finished\n                // (possibly the loaders or the play function are still running). We use the controller\n                // as a method to abort them, ASAP, but this is not foolproof as we cannot control what\n                // happens inside the user's code.\n                _this8.abortController.abort();\n\n                _this8.storyStore.cleanupStory(story);\n\n                _this8.channel.off(Events.UPDATE_GLOBALS, render);\n\n                _this8.channel.off(Events.FORCE_RE_RENDER, render);\n\n                _this8.channel.off(Events.FORCE_REMOUNT, remountStoryIfMatches);\n\n                _this8.channel.off(Events.UPDATE_STORY_ARGS, rerenderStoryIfMatches);\n\n                _this8.channel.off(Events.RESET_STORY_ARGS, rerenderStoryIfMatches); // Check if we're done rendering/playing. If not, we may have to reload the page.\n\n\n                if (isPending()) {\n                  _context15.next = 9;\n                  break;\n                }\n\n                return _context15.abrupt(\"return\");\n\n              case 9:\n                _context15.next = 11;\n                return new Promise(function (resolve) {\n                  return setTimeout(resolve, 0);\n                });\n\n              case 11:\n                if (isPending()) {\n                  _context15.next = 13;\n                  break;\n                }\n\n                return _context15.abrupt(\"return\");\n\n              case 13:\n                _context15.next = 15;\n                return new Promise(function (resolve) {\n                  return setTimeout(resolve, 0);\n                });\n\n              case 15:\n                if (isPending()) {\n                  _context15.next = 17;\n                  break;\n                }\n\n                return _context15.abrupt(\"return\");\n\n              case 17:\n                _context15.next = 19;\n                return new Promise(function (resolve) {\n                  return setTimeout(resolve, 0);\n                });\n\n              case 19:\n                if (isPending()) {\n                  _context15.next = 21;\n                  break;\n                }\n\n                return _context15.abrupt(\"return\");\n\n              case 21:\n                // If we still haven't completed, reload the page (iframe) to ensure we have a clean slate\n                // for the next render. Since the reload can take a brief moment to happen, we want to stop\n                // further rendering by awaiting a never-resolving promise (which is destroyed on reload).\n                global.window.location.reload();\n                _context15.next = 24;\n                return new Promise(function () {});\n\n              case 24:\n              case \"end\":\n                return _context15.stop();\n            }\n          }\n        }, _callee15);\n      }));\n    }\n  }, {\n    key: \"cleanupPreviousRender\",\n    value: function () {\n      var _cleanupPreviousRender = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee16() {\n        var _this$previousStory, _this$previousStory$p, _this$previousSelecti3;\n\n        var _ref22,\n            _ref22$unmountDocs,\n            unmountDocs,\n            previousViewMode,\n            _args16 = arguments;\n\n        return regeneratorRuntime.wrap(function _callee16$(_context16) {\n          while (1) {\n            switch (_context16.prev = _context16.next) {\n              case 0:\n                _ref22 = _args16.length > 0 && _args16[0] !== undefined ? _args16[0] : {}, _ref22$unmountDocs = _ref22.unmountDocs, unmountDocs = _ref22$unmountDocs === void 0 ? true : _ref22$unmountDocs;\n                previousViewMode = (_this$previousStory = this.previousStory) !== null && _this$previousStory !== void 0 && (_this$previousStory$p = _this$previousStory.parameters) !== null && _this$previousStory$p !== void 0 && _this$previousStory$p.docsOnly ? 'docs' : (_this$previousSelecti3 = this.previousSelection) === null || _this$previousSelecti3 === void 0 ? void 0 : _this$previousSelecti3.viewMode;\n\n                if (!(unmountDocs && previousViewMode === 'docs')) {\n                  _context16.next = 6;\n                  break;\n                }\n\n                _context16.next = 5;\n                return import('./renderDocs');\n\n              case 5:\n                _context16.sent.unmountDocs(this.view.docsRoot());\n\n              case 6:\n                if (!this.previousCleanup) {\n                  _context16.next = 9;\n                  break;\n                }\n\n                _context16.next = 9;\n                return this.previousCleanup();\n\n              case 9:\n              case \"end\":\n                return _context16.stop();\n            }\n          }\n        }, _callee16, this);\n      }));\n\n      function cleanupPreviousRender() {\n        return _cleanupPreviousRender.apply(this, arguments);\n      }\n\n      return cleanupPreviousRender;\n    }()\n  }, {\n    key: \"renderPreviewEntryError\",\n    value: function renderPreviewEntryError(reason, err) {\n      logger.error(reason);\n      logger.error(err);\n      this.view.showErrorDisplay(err);\n      this.channel.emit(Events.CONFIG_ERROR, err);\n    }\n  }, {\n    key: \"renderMissingStory\",\n    value: function renderMissingStory() {\n      logger.error(\"No story selected\");\n      this.view.showNoPreview();\n      this.channel.emit(Events.STORY_MISSING);\n    }\n  }, {\n    key: \"renderStoryLoadingException\",\n    value: function renderStoryLoadingException(storySpecifier, err) {\n      logger.error(\"Unable to load story '\".concat(storySpecifier, \"':\"));\n      logger.error(err);\n      this.view.showErrorDisplay(err);\n      this.channel.emit(Events.STORY_MISSING, storySpecifier);\n    } // renderException is used if we fail to render the story and it is uncaught by the app layer\n\n  }, {\n    key: \"renderException\",\n    value: function renderException(storyId, err) {\n      this.channel.emit(Events.STORY_THREW_EXCEPTION, err);\n      this.channel.emit(Events.STORY_RENDER_PHASE_CHANGED, {\n        newPhase: 'errored',\n        storyId: storyId\n      }); // Ignored exceptions exist for control flow purposes, and are typically handled elsewhere.\n\n      if (err !== IGNORED_EXCEPTION) {\n        this.view.showErrorDisplay(err);\n        logger.error(\"Error rendering story '\".concat(storyId, \"':\"));\n        logger.error(err);\n      }\n    } // renderError is used by the various app layers to inform the user they have done something\n    // wrong -- for instance returned the wrong thing from a story\n\n  }, {\n    key: \"renderError\",\n    value: function renderError(storyId, _ref23) {\n      var title = _ref23.title,\n          description = _ref23.description;\n      logger.error(\"Error rendering story \".concat(title, \": \").concat(description));\n      this.channel.emit(Events.STORY_ERRORED, {\n        title: title,\n        description: description\n      });\n      this.channel.emit(Events.STORY_RENDER_PHASE_CHANGED, {\n        newPhase: 'errored',\n        storyId: storyId\n      });\n      this.view.showErrorDisplay({\n        message: title,\n        stack: description\n      });\n    }\n  }]);\n\n  return PreviewWeb;\n}();"]},"metadata":{},"sourceType":"module"}